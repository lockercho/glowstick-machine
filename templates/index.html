 <html>
    <head>
		<!--Import Google Icon Font--><!-- 
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
		<link type="text/css" rel="stylesheet" href="reset.css"/>
		<!--Import materialize.css-->
		<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>

		<link type="text/css" rel="stylesheet" href="style.css"/>

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
		<!--Import jQuery before materialize.js-->
		<script type="text/javascript" src="jquery-3.2.1.min.js"></script>
		<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
		<script type="text/javascript" src="instascan.min.js"></script>
		<div id="return" class="z-depth-2">
			返回
		</div>
		<div id="big_logo">
			<div id="big_logo_image"></div>
			<div id="big_logo_text">
				感謝使用
			</div>
		</div>
		<div id="main">
			<div id="logo" class="z-depth-2"></div>
			<div id="welcome" class="z-depth-4">
				歡迎使用<br>
				美麗ㄉ螢光棒ㄉ系統
			</div>
			<div id="advertise"></div>

			<div id="instruction" class="card">
	            <div class="card-content">
	              <span class="card-title">示意圖ㄉ標題</span>
	              <p><video id="preview"></video></p>
	            </div>
	            <div id="instruction_hover">
	            	掃描成功
	            </div>
			</div>
			<div id="arrow">
				<div class="arrow-body">
					請取棒
				</div>
				<div class="arrow-head"></div>
			</div>
		</div>
		<div id="lower_text"></div>
    </body>
</html>
<script type="text/javascript" src="socket.io.min.js"></script>
<script type="text/javascript" >
	function setDefaultState() {
		state = {};
		state.mode = 'pending';
		state.visible = {};
		state.text = {};
		state.visible.main = true;
		state.visible.big_logo = false;
		state.visible.welcome = true;
		state.visible.return = false;
		state.visible.advertise = true;
		state.visible.instruction = false;
		state.visible.instruction_hover = false;
		state.visible.arrow = false;
		state.text.lower_text = '';

	}

	// var state
	function handleText() {
		Object.keys(state.text).map(function(key) {
			var $el = $('#' + key);
			if(!$el) 
				return;
			$el.html(state.text[key]);
		})
	}

	function handleVisible() {
		Object.keys(state.visible).map(function(key) {
			var $el = $('#' + key);
			if(!$el) 
				return;
			if(state.visible[key]) {
				$el.show();
			} else {
				$el.hide();
			}
		})
	}

	function render() {
		handleText();
		handleVisible();
		console.log('MODE', state.mode)
	}

	function onQRCodeSuccess(content) {
		var info = content.split('-');
		state.visible.instruction_hover = true;
		state.text.instruction_hover = 
			'掃描成功，您的座位是' + info[0] + '區' + info[1] + '排' + info[2] + '號';

		render();
		setTimeout(function() {
			state.mode = 'wait_uu';
			state.text.lower_text = '請感應悠遊卡<br>XXXX';
			state.visible.instruction_hover = false;
			render();
			// setTimeout(onUUCardDetected, 800)
		}, 800);
	}

	function onUUCardDetected() {
		state.mode = 'read_uu';
		state.visible.instruction_hover = true;
		state.text.instruction_hover = '讀取中，請勿移動';
		render();
		// setTimeout(onUUCardSuccess, 800);
	}

	function onUUCardFailure() {
		state.visible.instruction_hover = true;
		state.text.instruction_hover = '扣款失敗，餘額不足';
		render();
		setTimeout(onUUCardSuccess, 800);
	}

	function onUUCardSuccess() {
		state.mode = 'wait_take';
		state.visible.instruction_hover = false;
		state.text.instruction_hover = '';
		state.text.lower_text = '';
		state.visible.arrow = true;
		render();
		setTimeout(onStickTaken, 800);
	}

	function onStickTaken() {
		state.visible.main = false;
		state.visible.big_logo = true;
		render();
		setTimeout(function() {
			setDefaultState();
			render();
		}, 800);
	}
	
	var state = {};
	setDefaultState();
	render();


	$('#welcome').on('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		state.mode = 'wait_qr';
		state.visible.welcome = false;
		state.visible.return = true;
		state.visible.instruction = true;
		state.text.lower_text = '請掃描QR code<br>XXXX';
		render()
	})

	$('#return').on('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		setDefaultState();
		render()
	})

	// Config websocket
	var socket = io.connect();
	socket.on('connect', function() {
	    socket.emit('message', 'I\'m connected!');
	});
	socket.on('event', function(message) {
		console.log('event', message)
		try {
			var data = JSON.parse(message);
			if(data.tag == 'rfid' && state.mode == 'wait_qr') {
				return onQRCodeSuccess();
			}
			if(data.tag == 'rfid' && state.mode == 'wait_uu') {
				return onUUCardDetected();
			}
			if(data.tag == 'rfid' && state.mode == 'read_uu') {
				return onUUCardSuccess();
			}
		} catch(e) {}
	});

	// Config QR code scanner
	var scanner = new Instascan.Scanner({ 
		video: document.getElementById('preview') 
	});
    scanner.addListener('scan', function (content) {
    	if(state.mode == 'wait_qr') {
    		onQRCodeSuccess(content)
    	}
        console.log(content);
    });
    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.start(cameras[0]);
        } else {
            console.error('No cameras found.');
        }
    }).catch(function (e) {
        console.error(e);
    });

</script>
